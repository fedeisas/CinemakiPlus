<html>

<head>
<!--
    1. bajar lista de pelis
    2. cruzarla con localstorage
    3. buscar torrents de las que no tengan

    4. las que no tiene torrent van a una lista de texto abajo. 

     
-->
 
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript" language="JavaScript"></script>

<style>
    h1 {
        font-size:16px;
        margin:10px 0;
        text-transform: uppercase;
    }
    h2 {
        font-size:14px;
        margin:5px 0;
    }

    #disclaimer {
        color: #999;
        font-size:9px;
    }

    body {
        font-family: "Arial", sans-serif;
        color:#555 ;
        width:200px;
        font-size:12px;
        width:282px;
        overflow:hidden;
    }
    #met { font-weight:bold}
    a {
        color:#666;
    }

    .b1 {
        font-weight:bold;
        background:#ccc;
        padding:3px;
        font-size:14px;
    }
    #status {
        color:red ;
        font-weight:bold;
        min-height:1.5em;

    }

    #movies {
        padding:0;
        width:280px;
        overflow:hidden;
        height: 422px;
    }

    #movies li {
        float: left;
        margin:1px;
        padding:2px 1px;
        width:66px;
        height:135px;
        overflow:hidden;
        background:#ccc;
        text-align:center;
        -webkit-border-radius: 4px;
    }



    .foot {
        margin-top:2px;
        border-top:1px solid #999;
        padding:2px;
        overflow:hidden;

    }
    .foot a {
        text-decoration:none;
    }
    .butt {
        float:right;
        background: #3300ff;
        color: #ddd;
        -moz-border-radius: 4px;
        -webkit-border-radius: 4px;
        border: 1px solid #444;
        padding: 4px;
    }

    .butt2 {
        float:left;
        background: #444;
        color: white;
        -moz-border-radius: 4px;
        -webkit-border-radius: 4px;
        padding: 3px;
        margin:2px auto;
        text-align:center;
        width:55px;
        text-decoration:none;
        height:15px;
        overflow:hidden;
    }

    .nbutt2 {
        height:25px;
        overflow:hidden;
        line-height:25px;
    }

    #warn {color :#777};

    * {
        padding:0;
        margin:0;
    }
</style>

<script>
    onload = setTimeout(init,0);


    var config;
    var movie;
    var movies_ids;
    var t_session_id;
    var u_cookie;
    var u_token;
    var total_done = 0;


    function processTPB(data) {
        var d = document.getElementById("log");


        var data2 = data.substr(data.indexOf('<body>')+6);
        data2 = data2.replace(/\<iframe.*?\/iframe\>/g,'');
        data2 = data2.replace(/\<form.*?\/form\>/g,'');

        d.innerHTML = data2;

        var c=0;
        var torrent = new Array;

        $('a[href^="http://torrents.thepiratebay.org/"]').each(function()
        {
 //           console.log("torrent "+ c + ":" + $(this).attr("href"));


            var t = new Object;

            t.url = $(this).attr("href");

            var text =  $(this).parent().text();

            var p = text.indexOf("MiB");

            if ( p  < 0 )  p = text.indexOf("GiB");


            if ( p  > 0 ) {

                var unit = text.substr(p,3);
                var val = text.substr(p-8,7);

                val = val.replace(/[^\d,.]/g, '');

/*                console.log("val:",val);
                console.log("unit:",unit);
*/                if (unit == 'MiB') {
                    t.size = parseFloat(val) ;
                }
                else if (unit == 'GiB') {
                    t.size = parseFloat(val) * 1024;
                }
//                console.log("size:",t.size);
            }


            if (t.size 
                && t.size > config.min_size
                && t.size < config.max_size
                ) {
                torrent[c++] = t;
            }
        });

        console.log( "Encontré " + c + " torrents");

        return torrent[0];
    }


    function addTorrent(torrent, allow_restart) {


        status("Hablando con Transmission...");

        var myload = JSON.stringify({
                "method": "torrent-add",
                "tag": 39693,
                "arguments": { "filename": torrent.torrent_url }
                }
        );

        log("agregando a transmission " + myload);

        var xhr = $.ajax({
                type: "POST",
                headers: {"X-Transmission-Session-Id": t_session_id},
                url: "http://localhost:9091/transmission/rpc",  
                data: myload , 
                dataType: "json",
                success: function(d) {

                    log(torrent.title + " added to Transmission " + d.result );

                    if (d.result=="duplicate torrent") {
                        torrent.transmission_duplicate=1;
                        torrent.done = 1;
                        status("torrent duplicado: " + torrent.title);
                    }
                    else if (d.result.match(/404/)) {
                        status("error en torrent :-( : " + torrent.title);
                        torrent.done = 1;
                    }
                    else if (d && d.arguments["torrent-added"]) {
                        status("torrent agregado!! :-) " + torrent.title);
                        torrent.transmission_tid = d.arguments["torrent-added"].id;
                        torrent.transmission_hash = d.arguments["torrent-added"].hashString;
                        torrent.done = 1;
                    }

                    saveStorage();
                    updateDisplay();
                },
                statusCode: {
                    409: function() {
                        t_session_id = xhr.getResponseHeader("X-Transmission-Session-Id");
                        console.log("409...working! =>" + t_session_id );
                        if (allow_restart) addTorrent(torrent,0);
                    }
                }
            });

    }



    function u_base_url()  {

        var ret = 
            "http://"
            + config.utorrent_user
            + ":"
            + config.utorrent_pass
            + "@"
            + config.utorrent_host
            + ":"
            + config.utorrent_port
            + "/gui/"
            ;

        return ret;
    }



    function addUTorrent(m, allow_restart) {

        status("Hablando con uTorrent...");
        var url =
            u_base_url()
            + "?action=add-url&s="
            +  m.torrent_url
            + "&token="
            + u_token
            ;
        

        var xhr = $.ajax({
                type: "GET",
                url: url,
                success: function(d) {

                    log(m.title + " added to uTorrent");
                    m.done = 1;
                    saveStorage();
                    updateDisplay();
                },
                statusCode: {
                    400: function() {
                        console.log("400...error auth");
                        if (allow_restart) addUTorrent(torrent,0);
                    }
                },
                error: function() {
                        status("Falla al agregar a uTorrent. Revisa las opciones");
                }
            });

    }




    function getTPB(i,title,year) {

        var u = "http://thepiratebay.org/search/" + escape(title) + "%20" + year + "/0/99/200";

//        log("Buscando torrent para: " +  title + " => " + u);


        $.get(
            u,
            function(data) {

//                log("Procesando TPB");

                var t = processTPB(data); 
                movie[i].tried = 1;

                if ( typeof(t) != "undefined" && t.url) {
//                    log( title + "("+ i + ") => " + t.url);

                    movie[i].torrent_url = t.url;
                    movie[i].torrent_size_mb= t.size;


                }
                else {
                }
                saveStorage();
                updateDisplay();
            }
        );
    }

    function log(text) {
        console.log(text);
    }

    function status(text) {

        log(text);

        // Update status to let user know options were saved.
        var status = document.getElementById("status");
        status.innerHTML = text;

        setTimeout(function() {
            status.innerHTML = "";
        }, 4000);
    }

    function hideTorrent(movie_id) {

        $("#movie-"+movie_id).fadeOut();
        movie[movie_id].done=1;
        total_done++;
        saveStorage();
    }

    function download2(movie_id) {

        $("#movie-" +  movie_id).fadeOut('slow');


        log("download de movie_id: " + movie_id);

        if (config.utorrent) add1_Utorrent(movie_id);
        if (config.transmission) add1_Transmission(movie_id);
        saveStorage();
    }



    function updateDisplay () {

        
        var movieList = document.getElementById('movies');

        movieList.innerHTML= '';
        total_done=0;

        for(var i=0,len = movies_ids.length; movie_id=movies_ids[i], i<len; i++) {
        
            var e = movie[movie_id];

            if (e.done) {
                total_done++;
                continue;
            }

            var d = document.createElement('li');
            d.setAttribute("id","movie-" +  movie_id);



                var l = document.createElement('a');
                l.setAttribute("href", e.url );
                l.setAttribute("target", "_blank" );


                var title = unescape(e.title) + " (" + e.year + ")";
                var img = document.createElement('img');
                var txt = e.title + " | en agenda desde hace " + e.when;
                img.setAttribute('src',e.img);
                img.setAttribute('title',txt);
                img.setAttribute('alt',txt);
                img.setAttribute('height',"96px");
                img.setAttribute('width',"64px");
                l.appendChild(img);
            d.appendChild(l);
                 

            if (e.torrent_url) {
                var l2 = document.createElement('a');

                l2.setAttribute("id", "d" +  movie_id);
                l2.setAttribute("class","h");

                if (config.download) {
                    l2.setAttribute("href", e.torrent_url);
                    l2.setAttribute("target", "_blank" );
                    l2.setAttribute("onclick", "movie["+movie_id+"].done=1" );
                }
                else {
                    l2.setAttribute("href", "#");
                    l2.setAttribute("onclick", "download2("+ movie_id+")" );
                }

                l2.setAttribute("class", "butt2" );
                l2.innerHTML = "Bajar";
                d.appendChild(l2);
            }
            else {
                var l2 = document.createElement('div');
                l2.setAttribute("class", "nbutt2" );
                l2.innerHTML = "N / D";
                d.appendChild(l2);
            }

                var l2 = document.createElement('a');
                l2 = document.createElement('a');
                l2.setAttribute("href", "#" );
                l2.setAttribute("onclick", "hideTorrent("+ movie_id+")" );
                l2.setAttribute("class", "butt3" );
                l2.innerHTML = "Ocultar";
            d.appendChild(l2);


            movieList.appendChild(d);

        }

    }

    function storeScheduled(scheduled) {

        movies_ids = new Array();
        for (var i in scheduled.movies) {

            var e = scheduled.movies[i];

            if ( ! movie[e.id] ) {

                movie[e.id]        = new Object;
                movie[e.id].title  = unescape(e.title);
                movie[e.id].year   = e.year;
                movie[e.id].status = "nueva";
                movie[e.id].url    = e.url;
                movie[e.id].img    = e.img;
                movie[e.id].when   = e.when;
            }

            movies_ids.push(e.id);
        }
    }

    function saveStorage() {
        localStorage.setItem('ckplus', JSON.stringify(movie));
    }

    function refreshTorrents() {

        log("buscando torrents");

        for(var i=0,len=movies_ids.length; movie_id=movies_ids[i], i<len; i++) {
            var e = movie[movie_id];

            if (e.done) continue;

//log(e.torrent_url);            
            if (! e.torrent_url && ! e.tried) {
                getTPB(movie_id, e.title,e.year);
            }

//DEBUG
//break;
        }
        log('');
    }


    function resetTransmission() {

        document.getElementById('movies').innerHTML = '';

        for (var i in movie) {
            var e = movie[i];
            if (e.done) continue;


            e.transmission_hash      = null;
            e.transmission_duplicate = null;
        }
        updateDisplay();
    }


    function updateTransmission() {

        if ( config.transmission) {
            status("Actualizando Transmission");
            for (var i in movie) {
                var e = movie[i];


                if (e.done) continue;

                if (! e.transmission_hash && ! e.transmission_duplicate) {
                    addTorrent(e, 1);
                }


                log("");
            }
        }
    }

    function getUTokens() {

        var url = u_base_url() + 'token.html';

        $.get(url, function(data) {
            u_token = data.substr(data.indexOf("none;")+7,64); 
            for (var i in movie) {
                    var e = movie[i];

                    if (e.done) continue;

                    if (! e.utorrent_ok ) {
                        addUTorrent(e, 1);
                    }
            }

        })
        .error(function() { log("error con utorrent"); })
    }


    function add1_Utorrent(movie_id) {

        var url = u_base_url() + 'token.html';

        $.get(url, function(data) {
            u_token = data.substr(data.indexOf("none;")+7,64); 
            addUTorrent(movie[movie_id], 1);
        })
        .error(function() { status("error con utorrent"); })
    }


    function add1_Transmission(movie_id) {

        var e = movie[movie_id];

        if (! e.transmission_hash && ! e.transmission_duplicate) {
            addTorrent(e, 1);
        }
    }



    function updateUtorrent() {

        if ( config.utorrent) {

            status("Actualizando uTorrent");
            getUTokens();

        }
    }




    function getScheduled(id) {

        status("Contactando Cinemaki...");

        $.get(
            "http://www.cinemaki.com.ar/scheduled/" + id  
                    + "/limit/24"
                    + "/start/" + total_done ,
            function(data) {

                log("procesando Cinemaki");


                var scheduled = jQuery.parseJSON(data);

                status("Traje " + scheduled.movies.length + " pelis en tu agenda"); 

console.log(scheduled.user);
                $("#user").html(scheduled.user);

                storeScheduled(scheduled);
                updateDisplay();

                saveStorage();

                status("Buscando torrents");
                refreshTorrents();

//                updateTransmission();
//                updateUtorrent();
            }
        );
    }

    function resyncme() {
        resetTransmission();
        getScheduled(config.ck_id);
    }


    function init() {

        // Retrieve the config from storage
        var t = localStorage.getItem('config');


        if (t) {
            config = JSON.parse(t);
        }
        else  {
            config = new Object;
            config.min_size = 500;
            config.max_size = 1600;
            config.ck_id    = 12;
            config.transmission    = false;
            config.utorrent        = false;
            config.download        = true;
            config.concurrent     = 10;
        }


        // Retrieve the object from storage
        var t = localStorage.getItem('ckplus');

        if (t) {
            movie = JSON.parse(t);
        }
        else  {
            movie = new Object;
        }


        if (config.utorrent) 
            $("#met").html('uTorrent');

        if (config.transmission) 
            $("#met").html('Transmission');

        if (config.download) 
            $("#met").html('link a torrent');



        getScheduled(config.ck_id);
    }
</script>
        
</head>

<body>
    <h1> Tu agenda Cinemaki </h1>
    <h2> Usuario: <span id="user">n/d</span> </h2>
        <ul id="movies">
        <b>Opss, nada por aquí. </b>
        <p>
        Definí tu agenda en <a href="cinemaki.com">Cinemaki.com</a>
        Y luego configura tu ID de usuario en "Opciones"</ul>

    <div class="foot">
        <a href="#" onclick="resyncme()" class="butt">Refrescar</a>
        Método de descarga: <span id="met">ninguno</span>
        <br>(se cambia en opciones)
    </div>
    <div id="status"> </div>
    <div id="disclaimer">
    (*) Esta applicación no esta relaciona con Cinemaki.com, ni con sus propietarios
    </div>
    <div id="log" style="display:none"></div>
</body>

</html>
