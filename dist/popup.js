onload=setTimeout(init,0);var config,movie,movies_ids,t_session_id,u_cookie,u_token,total_done=0;function processTPB(b){var e,g,f,a;e=document.getElementById("log");g=b.substr(b.indexOf("<body>")+6);g=g.replace(/\<iframe.*?\/iframe\>/g,"");g=g.replace(/\<form.*?\/form\>/g,"");e.innerHTML=g;f=0;a=new Array;$('a[href^="http://torrents.thepiratebay.org/"]').each(function(){var c=new Object;c.url=$(this).attr("href");var j=$(this).parent().text();var h=j.indexOf("MiB");if(h<0){h=j.indexOf("GiB")}if(h>0){var d=j.substr(h,3);var i=j.substr(h-8,7);i=i.replace(/[^\d,.]/g,"");if(d=="MiB"){c.size=parseFloat(i)}else{if(d=="GiB"){c.size=parseFloat(i)*1024}}}if(c.size&&c.size>config.min_size&&c.size<config.max_size){a[f++]=c}});console.log("EncontrÃ© "+f+" torrents");return a[0]}function addTorrent(b,a){status("Hablando con Transmission...","info");var d=JSON.stringify({method:"torrent-add",tag:39693,"arguments":{filename:b.torrent_url}});log("agregando a transmission "+d);var c=$.ajax({type:"POST",headers:{"X-Transmission-Session-Id":t_session_id},url:"http://localhost:9091/transmission/rpc",data:d,dataType:"json",success:function(e){log(b.title+" added to Transmission "+e.result);if(e.result=="duplicate torrent"){b.transmission_duplicate=1;b.done=1;status("Torrent duplicado: "+b.title,"error")}else{if(e.result.match(/404/)){status("Error en torrent :-( : "+b.title,"error");b.done=1}else{if(e&&e.arguments["torrent-added"]){status("Torrent agregado!! :-) "+b.title,"success");b.transmission_tid=e.arguments["torrent-added"].id;b.transmission_hash=e.arguments["torrent-added"].hashString;b.done=1}}}saveStorage();updateDisplay()},statusCode:{409:function(){t_session_id=c.getResponseHeader("X-Transmission-Session-Id");console.log("409...working! =>"+t_session_id);if(a){addTorrent(b,0)}}}})}function u_base_url(){var a="http://"+config.utorrent_user+":"+config.utorrent_pass+"@"+config.utorrent_host+":"+config.utorrent_port+"/gui/";return a}function addUTorrent(a,c){status("Hablando con uTorrent...","info");var b=u_base_url()+"?action=add-url&s="+a.torrent_url+"&token="+u_token;$.ajax({type:"GET",url:b,success:function(e){log(a.title+" added to uTorrent");a.done=1;saveStorage();updateDisplay()},statusCode:{400:function(){console.log("400...error auth");if(c){addUTorrent(torrent,0)}}},error:function(){status("Falla al agregar a uTorrent. Revisa las opciones","error")}})}function getTPB(b,d,c){var a="http://thepiratebay.org/search/"+escape(d)+"%20"+c+"/0/99/200";$.get(a,function(f){var e=processTPB(f);movie[b].tried=1;if(typeof(e)!="undefined"&&e.url){movie[b].torrent_url=e.url;movie[b].torrent_size_mb=e.size}else{}saveStorage();updateDisplay()})}function log(a){}function status(b,a){log(b);var a=typeof(a)!="undefined"?a:"info";$("#status").removeClass().addClass("alert-message");$("#status p").html(b);$("#status").addClass(a).fadeIn();setTimeout(function(){$("#status").fadeOut("fast",function(){$("#status").removeClass(a)})},4000)}function hideTorrent(a){$("#movie-"+a).fadeOut();movie[a].done=1;total_done++;saveStorage()}function download2(a){$("#movie-"+a).fadeOut("slow");log("download de movie_id: "+a);if(config.utorrent){add1_Utorrent(a)}if(config.transmission){add1_Transmission(a)}saveStorage()}function updateDisplay(){$("#movies").empty();total_done=0;var b=[];for(var c=0,a=movies_ids.length;movie_id=movies_ids[c],c<a;c++){var d=movie[movie_id];d.movie_id=movie_id;if(d.done){total_done++;continue}b.push(d)}$("#movieTemplate").tmpl(b).appendTo("#movies")}function storeScheduled(b){movies_ids=new Array();for(var a in b.movies){var c=b.movies[a];if(!movie[c.id]){movie[c.id]=new Object;movie[c.id].title=unescape(c.title);movie[c.id].year=c.year;movie[c.id].status="nueva";movie[c.id].url=c.url;movie[c.id].img=c.img;movie[c.id].when=c.when}movies_ids.push(c.id)}}function saveStorage(){localStorage.setItem("ckplus",JSON.stringify(movie))}function refreshTorrents(){log("buscando torrents");for(var b=0,a=movies_ids.length;movie_id=movies_ids[b],b<a;b++){var c=movie[movie_id];if(c.done){continue}if(!c.torrent_url&&!c.tried){getTPB(movie_id,c.title,c.year)}}log("")}function resetTransmission(){document.getElementById("movies").innerHTML="";for(var a in movie){var b=movie[a];if(b.done){continue}b.transmission_hash=null;b.transmission_duplicate=null}updateDisplay()}function updateTransmission(){if(config.transmission){status("Actualizando Transmission...","info");for(var a in movie){var b=movie[a];if(b.done){continue}if(!b.transmission_hash&&!b.transmission_duplicate){addTorrent(b,1)}log("")}}}function getUTokens(){var a=u_base_url()+"token.html";$.get(a,function(c){u_token=c.substr(c.indexOf("none;")+7,64);for(var b in movie){var d=movie[b];if(d.done){continue}if(!d.utorrent_ok){addUTorrent(d,1)}}}).error(function(){log("error con utorrent")})}function add1_Utorrent(b){var a=u_base_url()+"token.html";$.get(a,function(c){u_token=c.substr(c.indexOf("none;")+7,64);addUTorrent(movie[b],1)}).error(function(){status("Error con uTorrent.","error")})}function add1_Transmission(a){var b=movie[a];if(!b.transmission_hash&&!b.transmission_duplicate){addTorrent(b,1)}}function updateUtorrent(){if(config.utorrent){status("Actualizando uTorrent...","info");getUTokens()}}function getScheduled(a){status("Contactando Cinemaki...","info");$.get("http://www.cinemaki.com.ar/scheduled/"+a+"/limit/24/start/"+total_done,function(c){log("procesando Cinemaki");var b=jQuery.parseJSON(c);status("Traje "+b.movies.length+" pelis en tu agenda","success");console.log(b.user);$("#user").html(b.user);storeScheduled(b);updateDisplay();saveStorage();status("Buscando torrents...","info");refreshTorrents()})}function resyncme(){resetTransmission();getScheduled(config.ck_id)}function init(){var a=localStorage.getItem("config");if(a){config=JSON.parse(a)}else{config=new Object;config.min_size=500;config.max_size=1600;config.ck_id=12;config.transmission=false;config.utorrent=false;config.download=true;config.concurrent=10}var a=localStorage.getItem("ckplus");if(a){movie=JSON.parse(a)}else{movie=new Object}if(config.utorrent){$("#met").html("uTorrent")}if(config.transmission){$("#met").html("Transmission")}if(config.download){$("#met").html("link a torrent")}getScheduled(config.ck_id)}$(document).ready(function(){$("ul#movies").delegate("li",{mouseenter:function(){$(this).children(".close").addClass("active")},mouseleave:function(){$(this).children(".close").removeClass("active")}})});